<!DOCTYPE html>
<html lang="zh-cmn">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
    <meta name="renderer" content="webkit"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="format-detection" content="telephone=no"/>

    <title>microapp授权test</title>
    <script src="http://g.alicdn.com/dingding/open-develop/1.6.9/dingtalk.js"></script>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script>
      var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          i;
        for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
          }
        }
      };
      function init_config() {
          $('#notify-btn').on('click', function () {
            dd.device.notification.alert({
              message: 'dd.device.notification.alert 内容',
              title: 'This is title 标题',
              buttonName: 'button按钮',
              onSuccess: function (data) {
                console.log('onSuccess: ', data);
              },
              onFail: function (err) {
                console.log('fail: ', err);
              }
            });
          });
          $('#user-btn').on('click', function () {
            dd.biz.user.get({
                onSuccess: function (info) {
                    $('#auth-result').html(JSON.stringify(info))
                },
                onFail: function (err) {
                    $('#auth-result').html(JSON.stringify(err))
                }
            });
          });
      }
      function auth_code_login(){
        dd.runtime.permission.requestAuthCode({
          corpId: corpId, //企业id
          onSuccess: function (info) {
            console.log('auth result', info);
            $('#auth-result').html('免登授权成功！获取用户信息...');
            $.post(
              '/api/dingtalk/js/login',
              {
                "code": info.code,
                "corp_id": corpId,
                "app_id": appId
              },
              function (result) {
                  if(result.code !== 0){
                      $('#auth-result').html(result.message)
                  }else{
                      $('#auth-result').html(result.data.user.name+"<br>"+result.data.corp.corp_name)
                  }
              }
            );

          },
          onFail: function (err) {
            $('#auth-result').html('免登授权失败：' + JSON.stringify(err));
            console.log('requestAuthCode fail: ' + JSON.stringify(err));
          }
        });
      }
      function get_user_info(){
          $.get(
              '/api/dingtalk/user/info',
              {},
              function (result) {
                  if(result.code !== 0){
                      if(result.code === 10001){
                          auth_code_login();
                          return
                      }
                      $('#auth-result').html(result.message)
                  }else{
                      $('#auth-result').html(result.data.user.name+"<br>"+result.data.corp.corp_name)
                  }
              }
          )
      }
      function init(){
        var corpId = getUrlParameter('corpId');
        var appId = getUrlParameter('appId');
        $.post(
          "/api/dingtalk/js/config",
          {
            "corp_id": corpId,
            "app_id": appId
          },
          function (result) {
            console.log("result", result);
            if(result.code !== 0){
                $('#url-p').html(result.message);
                return
            }
            var config = result.data;
            config["jsApiList"] = ['device.notification.confirm',
                'device.notification.alert',
                'device.notification.prompt',
                'biz.chat.chooseConversation',
                'biz.ding.post',
                'biz.user.get'
            ];
            dd.config(config);
            dd.ready(function () {
              $('#conf-result').html('配置成功！');
              console.log('dd ready');
              document.addEventListener('pause', function () {
                console.log('pause');
              });
              document.addEventListener('resume', function () {
                console.log('resume');
              });
              init_config();
              get_user_info();

            });
            dd.error(function (err) {
              $('#conf-result').html('配置失败：' + JSON.stringify(err));
              console.log('dd error: ', err);
            });
          });
      }
      $(document).ready(function () {
          init();
      });
    </script>
</head>
<body>
<p id="url-p">
</p>
<p id="conf-result">
    配置中...
</p>
<p id="auth-result"></p>

<button id="notify-btn" class="btn btn-block btn-default">显示通知</button>
<button id="user-btn" class="btn btn-block btn-default">本地用户信息</button>
<p id="user-result"></p>

</body>
</html>